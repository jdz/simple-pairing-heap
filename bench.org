#+title: Simple pairing heap benchmarks
#+options: num:nil toc:2 ^:nil

* Benchmark code                                                   :noexport:

The following two code blocks must be evaluated before evaluating the
benchmark blocks (using ~C-c C-c~).

#+caption: Setup code
#+begin_src lisp :results silent
  (in-package #:cl-user)

  (eval-when (:load-toplevel :compile-toplevel :execute)
    (unless (find-package '#:pairing-heap)
      (ql:quickload "pairing-heap"))
    (unless (find-package '#:bodge-heap)
      (ql:quickload "bodge-heap")))
#+end_src

#+caption: Benchmark code
#+begin_src lisp :results silent
  (in-package #:cl-user)

  (defun benchmark (&key (n 1000)
                         (m 1000)
                         (scale (expt n 2))
                         (repeat 50)
                         (warmup 10)
                         (key #'identity)
                         (node-constructor #'identity))
    (let ((init-items (loop repeat n
                            collect (funcall node-constructor (random scale))))
          (more-items (loop repeat m
                            collect (funcall node-constructor (random scale)))))
      (macrolet ((bench ((heap-var item-var description)
                         new add del)
                   `(progn
                      (fresh-line *trace-output*)
                      (write-line ,description *trace-output*)
                      ,#+sbcl (sb-ext:gc :full t)
                      (flet ((run ()
                               (let ((,heap-var ,new))
                                 (loop for ,item-var in init-items
                                       do ,add)
                                 (loop for ,item-var in more-items
                                       do ,del ,add))))
                        (loop repeat warmup do (run))
                        (time
                         (loop repeat repeat do (run)))))))
        (bench (heap item "PAIRING-HEAP")
               (pairing-heap:create :key key)
               (pairing-heap:insert item heap)
               (pairing-heap:pop-front heap))
        (bench (heap item "BODGE-HEAP")
               (bodge-heap:make-pairing-heap :key key)
               (bodge-heap:pairing-heap-push heap item)
               (bodge-heap:pairing-heap-pop heap))
        t)))
#+end_src

#+caption: Sampling code
#+name: run-benchmark
#+begin_src lisp :var heap-size=1000 reinserts=1000
  (let ((output (with-output-to-string (*trace-output*)
                  (format *trace-output*
                          "~&Heap of size ~D, with ~D reinserts, ~A ~A~%"
                          heap-size reinserts
                          (lisp-implementation-type)
                          (lisp-implementation-version))
                  (benchmark :n heap-size
                             :m reinserts
                             :node-constructor (lambda (n)
                                                 (cons n (format nil "~R" n)))
                             :key #'car))))
    (string-right-trim '(#\space #\return #\newline) output))
#+end_src

* Benchmarks with pairing heap nodes as cons cells
** CCL

#+call: run-benchmark(1000, 500000)

#+RESULTS:
#+begin_example
Heap of size 1000, with 500000 reinserts, Clozure Common Lisp Version 1.12 (v1.12-33-gc94c3a88) LinuxX8664
PAIRING-HEAP
(LOOP REPEAT REPEAT DO (RUN))
took 22,901,788 microseconds (22.901789 seconds) to run.
         58,992 microseconds ( 0.058992 seconds, 0.26%) of which was spent in GC.
During that period, and with 16 available CPU cores,
     23,191,845 microseconds (23.191845 seconds) were spent in user mode
        137,124 microseconds ( 0.137124 seconds) were spent in system mode
 1,350,148,000 bytes of memory allocated.
 65 minor page faults, 0 major page faults, 0 swaps.
BODGE-HEAP
(LOOP REPEAT REPEAT DO (RUN))
took 4,975,993 microseconds (4.975993 seconds) to run.
       161,004 microseconds (0.161004 seconds, 3.24%) of which was spent in GC.
During that period, and with 16 available CPU cores,
     5,263,986 microseconds (5.263986 seconds) were spent in user mode
        29,249 microseconds (0.029249 seconds) were spent in system mode
 1,202,401,600 bytes of memory allocated.
 129 minor page faults, 0 major page faults, 0 swaps.
#+end_example

Other benchmarks take even longer, so not even trying.

** SBCL

#+call: run-benchmark(1000, 500000)

#+RESULTS:
#+begin_example
Heap of size 1000, with 500000 reinserts, SBCL 2.1.10.73.HEAD.3-64dae8610
PAIRING-HEAP
Evaluation took:
  0.740 seconds of real time
  0.753094 seconds of total run time (0.752181 user, 0.000913 system)
  [ Run times consist of 0.012 seconds GC time, and 0.742 seconds non-GC time. ]
  101.76% CPU
  2,801,064,626 processor cycles
  1,347,759,952 bytes consed

BODGE-HEAP
Evaluation took:
  0.800 seconds of real time
  0.814853 seconds of total run time (0.814573 user, 0.000280 system)
  [ Run times consist of 0.010 seconds GC time, and 0.805 seconds non-GC time. ]
  101.88% CPU
  3,040,269,420 processor cycles
  1,202,370,912 bytes consed
#+end_example

#+call: run-benchmark(1000, 5000000)

#+RESULTS:
#+begin_example
Heap of size 1000, with 5000000 reinserts, SBCL 2.1.10.73.HEAD.3-64dae8610
PAIRING-HEAP
Evaluation took:
  6.430 seconds of real time
  6.545054 seconds of total run time (6.533345 user, 0.011709 system)
  [ Run times consist of 0.117 seconds GC time, and 6.429 seconds non-GC time. ]
  101.79% CPU
  24,390,721,040 processor cycles
  12,198,189,104 bytes consed

BODGE-HEAP
Evaluation took:
  7.186 seconds of real time
  7.295941 seconds of total run time (7.284913 user, 0.011028 system)
  [ Run times consist of 0.112 seconds GC time, and 7.184 seconds non-GC time. ]
  101.53% CPU
  27,250,511,360 processor cycles
  12,002,400,736 bytes consed
#+end_example

#+call: run-benchmark(50000, 1000000)

#+RESULTS:
#+begin_example
Heap of size 50000, with 1000000 reinserts, SBCL 2.1.10.73.HEAD.3-64dae8610
PAIRING-HEAP
Evaluation took:
  6.793 seconds of real time
  6.864078 seconds of total run time (6.766425 user, 0.097653 system)
  [ Run times consist of 0.314 seconds GC time, and 6.551 seconds non-GC time. ]
  101.05% CPU
  25,762,605,476 processor cycles
  8,191,046,672 bytes consed

BODGE-HEAP
Evaluation took:
  5.443 seconds of real time
  5.472650 seconds of total run time (5.472650 user, 0.000000 system)
  [ Run times consist of 0.090 seconds GC time, and 5.383 seconds non-GC time. ]
  100.55% CPU
  20,645,452,744 processor cycles
  2,519,984,176 bytes consed
#+end_example

* Benchmarks with pairing heap nodes as structs
** CCL

#+call: run-benchmark(1000, 500000)

#+RESULTS:
#+begin_example
Heap of size 1000, with 500000 reinserts, Clozure Common Lisp Version 1.12 (v1.12-33-gc94c3a88) LinuxX8664
PAIRING-HEAP
(LOOP REPEAT REPEAT DO (RUN))
took 3,006,359 microseconds (3.006359 seconds) to run.
        84,286 microseconds (0.084286 seconds, 2.80%) of which was spent in GC.
During that period, and with 16 available CPU cores,
     3,041,123 microseconds (3.041123 seconds) were spent in user mode
        71,727 microseconds (0.071727 seconds) were spent in system mode
 2,225,620,800 bytes of memory allocated.
 226 minor page faults, 0 major page faults, 0 swaps.
BODGE-HEAP
(LOOP REPEAT REPEAT DO (RUN))
took 4,976,360 microseconds (4.976360 seconds) to run.
       158,160 microseconds (0.158160 seconds, 3.18%) of which was spent in GC.
During that period, and with 16 available CPU cores,
     5,214,539 microseconds (5.214539 seconds) were spent in user mode
        68,192 microseconds (0.068192 seconds) were spent in system mode
 1,202,401,600 bytes of memory allocated.
 129 minor page faults, 0 major page faults, 0 swaps.
#+end_example

#+call: run-benchmark(1000, 5000000)

#+RESULTS:
#+begin_example
Heap of size 1000, with 5000000 reinserts, Clozure Common Lisp Version 1.12 (v1.12-33-gc94c3a88) LinuxX8664
PAIRING-HEAP
(LOOP REPEAT REPEAT DO (RUN))
took 27,812,277 microseconds (27.812277 seconds) to run.
        578,605 microseconds ( 0.578605 seconds, 2.08%) of which was spent in GC.
During that period, and with 16 available CPU cores,
     28,304,977 microseconds (28.304976 seconds) were spent in user mode
        479,501 microseconds ( 0.479501 seconds) were spent in system mode
 20,306,474,400 bytes of memory allocated.
 387 minor page faults, 0 major page faults, 0 swaps.
BODGE-HEAP
(LOOP REPEAT REPEAT DO (RUN))
took 45,550,609 microseconds (45.550610 seconds) to run.
      1,750,973 microseconds ( 1.750973 seconds, 3.84%) of which was spent in GC.
During that period, and with 16 available CPU cores,
     47,247,996 microseconds (47.247997 seconds) were spent in user mode
        371,431 microseconds ( 0.371431 seconds) were spent in system mode
 12,002,401,600 bytes of memory allocated.
 290 minor page faults, 0 major page faults, 0 swaps.
#+end_example

The last benchmark (size ~50000~, ~1000000~ reinserts) takes too long (and
eats memory like crazy), so not included.

** SBCL

#+call: run-benchmark(1000, 500000)

#+RESULTS:
#+begin_example
Heap of size 1000, with 500000 reinserts, SBCL 2.1.10.73.HEAD.3-64dae8610
PAIRING-HEAP
Evaluation took:
  0.993 seconds of real time
  0.998669 seconds of total run time (0.998658 user, 0.000011 system)
  [ Run times consist of 0.021 seconds GC time, and 0.978 seconds non-GC time. ]
  100.60% CPU
  3,766,689,124 processor cycles
  2,226,190,768 bytes consed

BODGE-HEAP
Evaluation took:
  0.806 seconds of real time
  0.809088 seconds of total run time (0.809088 user, 0.000000 system)
  [ Run times consist of 0.010 seconds GC time, and 0.800 seconds non-GC time. ]
  100.37% CPU
  3,062,393,780 processor cycles
  1,202,399,904 bytes consed
#+end_example

#+call: run-benchmark(1000, 5000000)

#+RESULTS:
#+begin_example
Heap of size 1000, with 5000000 reinserts, SBCL 2.1.10.73.HEAD.3-64dae8610
PAIRING-HEAP
Evaluation took:
  8.750 seconds of real time
  8.831415 seconds of total run time (8.821180 user, 0.010235 system)
  [ Run times consist of 0.193 seconds GC time, and 8.639 seconds non-GC time. ]
  100.93% CPU
  33,181,606,764 processor cycles
  20,302,848,720 bytes consed

BODGE-HEAP
Evaluation took:
  7.316 seconds of real time
  7.405160 seconds of total run time (7.367972 user, 0.037188 system)
  [ Run times consist of 0.111 seconds GC time, and 7.295 seconds non-GC time. ]
  101.22% CPU
  27,741,303,856 processor cycles
  12,002,376,352 bytes consed
#+end_example

#+call: run-benchmark(50000, 1000000)

#+RESULTS:
#+begin_example
Heap of size 50000, with 1000000 reinserts, SBCL 2.1.10.73.HEAD.3-64dae8610
PAIRING-HEAP
Evaluation took:
  8.593 seconds of real time
  8.689080 seconds of total run time (8.530174 user, 0.158906 system)
  [ Run times consist of 0.656 seconds GC time, and 8.034 seconds non-GC time. ]
  101.12% CPU
  32,598,229,320 processor cycles
  12,663,746,272 bytes consed

BODGE-HEAP
Evaluation took:
  5.380 seconds of real time
  5.397033 seconds of total run time (5.387871 user, 0.009162 system)
  [ Run times consist of 0.090 seconds GC time, and 5.308 seconds non-GC time. ]
  100.32% CPU
  20,407,363,668 processor cycles
  2,519,980,288 bytes consed
#+end_example
